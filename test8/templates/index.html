<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>test8 Configuration</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <h1><i class="fas fa-cogs"></i> test8 Configuration</h1>
    </header>
    <div class="container">
        <div class="config-section">
            <h2><i class="fas fa-sliders-h"></i> Configuration</h2>
            <form id="configForm">
                <div class="form-group">
                    <label for="apiKey">API Key:</label>
                    <input type="text" id="apiKey" name="apiKey" value="{{ config.api_key }}" required>
                </div>

                <div class="form-group">
                    <label for="modelProvider">Model Provider:</label>
                    <select id="modelProvider" name="modelProvider" required>
                        <option value="">Select Provider</option>
                        <option value="OpenAI" {% if config.model_provider == 'OpenAI' %}selected{% endif %}>OpenAI</option>
                        <option value="Anthropic" {% if config.model_provider == 'Anthropic' %}selected{% endif %}>Anthropic</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="model">Model:</label>
                    <select id="model" name="model" required disabled>
                        <option value="">Select Model</option>
                    </select>
                </div>

                <div class="prompt-section">
                    <label>System Prompt:</label>
                    <div class="prompt-buttons">
                        <button type="button" class="btn btn-outline" id="defaultSystemPrompt">Default</button>
                        <button type="button" class="btn btn-outline" id="customSystemPrompt">Custom</button>
                    </div>
                    <textarea id="systemPrompt" name="systemPrompt" rows="4" style="display: none;">{{ config.system_prompt }}</textarea>
                </div>

                <div class="prompt-section">
                    <label>User Prompt:</label>
                    <div class="prompt-buttons">
                        <button type="button" class="btn btn-outline" id="defaultUserPrompt">Default</button>
                        <button type="button" class="btn btn-outline" id="customUserPrompt">Custom</button>
                    </div>
                    <textarea id="userPrompt" name="userPrompt" rows="4" style="display: none;">{{ config.user_prompt }}</textarea>
                </div>

                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Configuration</button>
            </form>
        </div>

        <div class="file-browser-section">
            <h2><i class="fas fa-folder-open"></i> File Browser</h2>
            <div id="fileList" class="file-list"></div>
            <div id="selectedFiles" class="selected-files"></div>
            <button id="runTestsBtn" class="btn btn-success" disabled><i class="fas fa-play"></i> Run Tests</button>
        </div>
    </div>
    
    <footer>
        <div class="author">
            <a href="https://www.linkedin.com/in/naserjamal/" target="_blank">By Naser Jamal</a>
        </div>
    </footer>

    <button id="modelHelpBtn" class="model-help-btn" title="Model Help">
        <i class="fas fa-question-circle"></i>
    </button>

    <div id="modelHelpModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div class="tab">
                <button class="tablinks active" onclick="openTab(event, 'Quality')"><i class="fas fa-star"></i> Quality</button>
                <button class="tablinks" onclick="openTab(event, 'Speed')"><i class="fas fa-bolt"></i> Speed</button>
                <button class="tablinks" onclick="openTab(event, 'Price')"><i class="fas fa-dollar-sign"></i> Price</button>
            </div>

            <div id="Quality" class="tabcontent" style="display:block;">
                <h3>Quality Ranking</h3>
                <ol class="ranking">
                    <li>Model 1 <span class="description">Description for Model 1</span></li>
                    <li>Model 2 <span class="description">Description for Model 2</span></li>
                    <li>Model 3 <span class="description">Description for Model 3</span></li>
                    <li>Model 4 <span class="description">Description for Model 4</span></li>
                </ol>
            </div>

            <div id="Speed" class="tabcontent">
                <h3>Speed Ranking</h3>
                <ol class="ranking">
                    <li>Model 1 <span class="description">Description for Model 1</span></li>
                    <li>Model 2 <span class="description">Description for Model 2</span></li>
                    <li>Model 3 <span class="description">Description for Model 3</span></li>
                    <li>Model 4 <span class="description">Description for Model 4</span></li>
                </ol>
            </div>

            <div id="Price" class="tabcontent">
                <h3>Price Ranking</h3>
                <ol class="ranking">
                    <li>Model 1 <span class="description">Description for Model 1</span></li>
                    <li>Model 2 <span class="description">Description for Model 2</span></li>
                    <li>Model 3 <span class="description">Description for Model 3</span></li>
                    <li>Model 4 <span class="description">Description for Model 4</span></li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const modelProvider = document.getElementById('modelProvider');
            const model = document.getElementById('model');
            const form = document.getElementById('configForm');
            const defaultSystemPrompt = document.getElementById('defaultSystemPrompt');
            const customSystemPrompt = document.getElementById('customSystemPrompt');
            const systemPromptTextarea = document.getElementById('systemPrompt');
            const defaultUserPrompt = document.getElementById('defaultUserPrompt');
            const customUserPrompt = document.getElementById('customUserPrompt');
            const userPromptTextarea = document.getElementById('userPrompt');
            const fileList = document.getElementById('fileList');
            const selectedFiles = document.getElementById('selectedFiles');
            const runTestsBtn = document.getElementById('runTestsBtn');

            const models = {
                OpenAI: ['gpt-4o-mini', 'gpt-4o-2024-08-06'],
                Anthropic: ['claude-3-5-sonnet-20240620', 'claude-3-haiku-20240307']
            };

            const defaultSystemPromptText = "You are a helpful assistant that generates Python unit tests for the file named '{file_name}'. Do not include code blocks or explanations in your response, just the unittest code.";
            const defaultUserPromptText = "Please generate unit tests for the following Python code from the file '{file_name}':\n\n{code_content}\n\nProvide a complete unittest class with test methods for each function in the code.\nDo not include any explanations or code blocks, just the unittest code.";

            let currentPath = '.';
            let selectedFilesList = [];

            function updateModelOptions() {
                model.innerHTML = '<option value="">Select Model</option>';
                model.disabled = !modelProvider.value;
                if (modelProvider.value) {
                    models[modelProvider.value].forEach(m => {
                        const option = document.createElement('option');
                        option.value = m;
                        option.textContent = m;
                        model.appendChild(option);
                    });
                }
            }

            function initializePrompts() {
                if (systemPromptTextarea.value !== defaultSystemPromptText) {
                    customSystemPrompt.click();
                } else {
                    defaultSystemPrompt.click();
                }

                if (userPromptTextarea.value !== defaultUserPromptText) {
                    customUserPrompt.click();
                } else {
                    defaultUserPrompt.click();
                }
            }

            function loadFiles(path) {
                showSpinner();
                fetch(`/browse?path=${encodeURIComponent(path)}`)
                    .then(response => response.json())
                    .then(data => {
                        fileList.innerHTML = '';
                        if (path !== '.') {
                            const backBtn = createFileItem('..', 'directory');
                            backBtn.onclick = () => loadFiles(path.split('/').slice(0, -1).join('/') || '.');
                            fileList.appendChild(backBtn);
                        }
                        data.forEach(item => {
                            const div = createFileItem(item.name, item.type);
                            if (item.type === 'directory') {
                                div.onclick = () => loadFiles(item.path);
                            } else if (item.name.endsWith('.py')) {
                                div.onclick = () => toggleFileSelection(item);
                            }
                            fileList.appendChild(div);
                        });
                        hideSpinner();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showErrorMessage('Failed to load files. Please try again.');
                        hideSpinner();
                    });
            }

            function createFileItem(name, type) {
                const div = document.createElement('div');
                div.textContent = name;
                div.classList.add('file-item', type, 'fade-in');
                return div;
            }

            function toggleFileSelection(file) {
                const index = selectedFilesList.findIndex(f => f.path === file.path);
                if (index > -1) {
                    selectedFilesList.splice(index, 1);
                } else {
                    selectedFilesList.push(file);
                }
                updateSelectedFiles();
            }

            function updateSelectedFiles() {
                selectedFiles.innerHTML = '';
                selectedFilesList.forEach(file => {
                    const div = document.createElement('div');
                    div.textContent = file.name;
                    div.classList.add('selected-file', 'fade-in');
                    selectedFiles.appendChild(div);
                });
                runTestsBtn.disabled = selectedFilesList.length === 0;
            }

            function showSpinner() {
                const spinner = document.createElement('div');
                spinner.classList.add('spinner');
                document.body.appendChild(spinner);
            }

            function hideSpinner() {
                const spinner = document.querySelector('.spinner');
                if (spinner) {
                    spinner.remove();
                }
            }

            function showErrorMessage(message) {
                const errorDiv = document.createElement('div');
                errorDiv.classList.add('error-message', 'fade-in');
                errorDiv.textContent = message;
                document.body.appendChild(errorDiv);
                setTimeout(() => {
                    errorDiv.remove();
                }, 5000);
            }

            function showSuccessMessage(message) {
                const successDiv = document.createElement('div');
                successDiv.classList.add('success-message', 'fade-in');
                successDiv.textContent = message;
                document.body.appendChild(successDiv);
                setTimeout(() => {
                    successDiv.remove();
                }, 5000);
            }

            modelProvider.addEventListener('change', updateModelOptions);

            defaultSystemPrompt.addEventListener('click', () => {
                systemPromptTextarea.value = defaultSystemPromptText;
                systemPromptTextarea.style.display = 'none';
                defaultSystemPrompt.classList.add('active');
                customSystemPrompt.classList.remove('active');
            });

            customSystemPrompt.addEventListener('click', () => {
                systemPromptTextarea.style.display = 'block';
                defaultSystemPrompt.classList.remove('active');
                customSystemPrompt.classList.add('active');
            });

            defaultUserPrompt.addEventListener('click', () => {
                userPromptTextarea.value = defaultUserPromptText;
                userPromptTextarea.style.display = 'none';
                defaultUserPrompt.classList.add('active');
                customUserPrompt.classList.remove('active');
            });

            customUserPrompt.addEventListener('click', () => {
                userPromptTextarea.style.display = 'block';
                defaultUserPrompt.classList.remove('active');
                customUserPrompt.classList.add('active');
            });

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                showSpinner();
                const config = {
                    api_key: document.getElementById('apiKey').value,
                    model_provider: modelProvider.value,
                    model: model.value,
                    system_prompt: systemPromptTextarea.value,
                    user_prompt: userPromptTextarea.value
                };
                fetch('/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(config),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showSuccessMessage('Configuration saved successfully!');
                    } else {
                        showErrorMessage('Failed to save configuration. Please try again.');
                    }
                    hideSpinner();
                })
                .catch((error) => {
                    console.error('Error:', error);
                    showErrorMessage('An error occurred while saving the configuration.');
                    hideSpinner();
                });
            });

            runTestsBtn.onclick = () => {
                showSpinner();
                const files = selectedFilesList.map(file => file.path);
                fetch('/run_tests', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ files }),
                })
                .then(response => response.json())
                .then(data => {
                    showSuccessMessage(data.message);
                    hideSpinner();
                })
                .catch(error => {
                    console.error('Error:', error);
                    showErrorMessage('An error occurred while running tests.');
                    hideSpinner();
                });
            };

            // Initialize the page
            updateModelOptions();
            initializePrompts();
            loadFiles(currentPath);

            // Model Help Modal
            const modal = document.getElementById("modelHelpModal");
            const btn = document.getElementById("modelHelpBtn");
            const span = document.getElementsByClassName("close")[0];

            btn.onclick = function() {
                modal.style.display = "flex";
            }

            span.onclick = function() {
                modal.style.display = "none";
            }

            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }

            function openTab(evt, tabName) {
                var i, tabcontent, tablinks;
                tabcontent = document.getElementsByClassName("tabcontent");
                for (i = 0; i < tabcontent.length; i++) {
                    tabcontent[i].style.display = "none";
                }
                tablinks = document.getElementsByClassName("tablinks");
                for (i = 0; i < tablinks.length; i++) {
                    tablinks[i].className = tablinks[i].className.replace(" active", "");
                }
                document.getElementById(tabName).style.display = "block";
                evt.currentTarget.className += " active";
            }

            // Add event listeners for tab buttons
            document.querySelectorAll('.tablinks').forEach(button => {
                button.addEventListener('click', function(event) {
                    openTab(event, this.textContent.trim());
                });
            });
        });
    </script>
</body>
</html>